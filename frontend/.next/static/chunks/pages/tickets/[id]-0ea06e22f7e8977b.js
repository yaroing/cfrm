(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[217],{1642:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/tickets/[id]",function(){return t(2190)}])},2190:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return u}});var a=t(5893),l=t(7294),r=t(9008),n=t.n(r),i=t(1163),c=t(214),d=t(1255),o=e=>{let{ticketId:s}=e,[t,r]=(0,l.useState)([]),[n,i]=(0,l.useState)(!0),[c,o]=(0,l.useState)(""),[x,m]=(0,l.useState)(!1),[u,h]=(0,l.useState)(!1);(0,l.useEffect)(()=>{g()},[s]);let g=async()=>{try{i(!0);let e=await d.E.get("/responses/?ticket=".concat(s));r(Array.isArray(e)?e:e.results||[])}catch(e){console.error("Erreur lors du chargement des r\xe9ponses:",e)}finally{i(!1)}},p=async e=>{if(e.preventDefault(),c.trim())try{h(!0),await d.E.post("/responses/",{ticket:s,content:c,is_internal:x}),o(""),m(!1),await g()}catch(e){console.error("Erreur lors de l'ajout de la r\xe9ponse:",e)}finally{h(!1)}},b=e=>new Date(e).toLocaleString("fr-FR");return n?(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"R\xe9ponses"}),(0,a.jsxs)("div",{className:"animate-pulse space-y-4",children:[(0,a.jsx)("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),(0,a.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/2"})]})]}):(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"R\xe9ponses"}),(0,a.jsx)("div",{className:"space-y-4 mb-6",children:0===t.length?(0,a.jsx)("p",{className:"text-gray-500 text-center py-4",children:"Aucune r\xe9ponse pour ce ticket"}):t.map(e=>(0,a.jsxs)("div",{className:"p-4 rounded-lg border ".concat(e.is_internal?"bg-yellow-50 border-yellow-200":"bg-gray-50 border-gray-200"),children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("span",{className:"font-medium text-gray-900",children:e.author_name||"Syst\xe8me"}),e.is_internal&&(0,a.jsx)("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800",children:"Interne"})]}),(0,a.jsx)("span",{className:"text-sm text-gray-500",children:b(e.created_at)})]}),(0,a.jsx)("div",{className:"text-gray-700 whitespace-pre-wrap",children:e.content}),e.sent_at&&(0,a.jsxs)("div",{className:"mt-2 text-xs text-gray-500",children:["Envoy\xe9 le: ",b(e.sent_at),e.delivery_status&&(0,a.jsxs)("span",{className:"ml-2",children:["Status: ",e.delivery_status]})]})]},e.id))}),(0,a.jsxs)("form",{onSubmit:p,className:"border-t pt-4",children:[(0,a.jsx)("h3",{className:"text-lg font-medium mb-3",children:"Ajouter une r\xe9ponse"}),(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsxs)("label",{className:"flex items-center",children:[(0,a.jsx)("input",{type:"checkbox",checked:x,onChange:e=>m(e.target.checked),className:"rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"}),(0,a.jsx)("span",{className:"ml-2 text-sm text-gray-700",children:"Note interne (non visible par le plaignant)"})]})}),(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsx)("textarea",{value:c,onChange:e=>o(e.target.value),placeholder:"Tapez votre r\xe9ponse...",rows:4,className:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500",required:!0})}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsx)("button",{type:"submit",disabled:u||!c.trim(),className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:u?"Envoi...":"Envoyer la r\xe9ponse"})})]})]})},x=e=>{let{ticketId:s}=e,[t,r]=(0,l.useState)([]),[n,i]=(0,l.useState)(!0);(0,l.useEffect)(()=>{c()},[s]);let c=async()=>{try{i(!0);let e=await d.E.get("/logs/?ticket=".concat(s,"&v=2"));r(Array.isArray(e)?e:e.results||[])}catch(e){console.error("Erreur lors du chargement des logs:",e)}finally{i(!1)}},o=e=>new Date(e).toLocaleString("fr-FR"),x=e=>{switch(e){case"created":return"\uD83C\uDD95";case"updated":return"✏️";case"assigned":return"\uD83D\uDC64";case"status_changed":return"\uD83D\uDD04";case"priority_changed":return"⚡";case"escalated":return"\uD83D\uDCC8";case"closed":return"\uD83D\uDD12";case"reopened":return"\uD83D\uDD13";case"response_added":return"\uD83D\uDCAC";default:return"\uD83D\uDCDD"}},m=e=>{switch(e){case"created":case"reopened":return"bg-green-100 text-green-800";case"updated":return"bg-blue-100 text-blue-800";case"assigned":return"bg-purple-100 text-purple-800";case"status_changed":return"bg-yellow-100 text-yellow-800";case"priority_changed":return"bg-orange-100 text-orange-800";case"escalated":return"bg-red-100 text-red-800";case"closed":default:return"bg-gray-100 text-gray-800";case"response_added":return"bg-indigo-100 text-indigo-800"}};return n?(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Historique"}),(0,a.jsxs)("div",{className:"animate-pulse space-y-4",children:[(0,a.jsx)("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),(0,a.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/2"})]})]}):(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Historique des modifications"}),0===t.length?(0,a.jsx)("p",{className:"text-gray-500 text-center py-4",children:"Aucun historique disponible"}):(0,a.jsx)("div",{className:"space-y-4",children:t.map(e=>(0,a.jsxs)("div",{className:"flex items-start space-x-3 p-3 bg-gray-50 rounded-lg",children:[(0,a.jsx)("div",{className:"flex-shrink-0",children:(0,a.jsx)("span",{className:"text-2xl",children:x(e.action)})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 mb-1",children:[(0,a.jsx)("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ".concat(m(e.action)),children:e.action_display}),(0,a.jsx)("span",{className:"text-sm text-gray-500",children:o(e.created_at)})]}),(0,a.jsx)("p",{className:"text-sm text-gray-900 mb-1",children:e.description}),e.user_name&&(0,a.jsxs)("p",{className:"text-xs text-gray-600",children:["Par: ",e.user_name]}),(e.old_value||e.new_value)&&(0,a.jsxs)("div",{className:"mt-2 text-xs",children:[e.old_value&&(0,a.jsxs)("span",{className:"text-red-600",children:["Ancien: ",e.old_value]}),e.old_value&&e.new_value&&(0,a.jsx)("span",{className:"mx-2",children:"→"}),e.new_value&&(0,a.jsxs)("span",{className:"text-green-600",children:["Nouveau: ",e.new_value]})]}),e.ip_address&&(0,a.jsxs)("p",{className:"text-xs text-gray-400 mt-1",children:["IP: ",e.ip_address]})]})]},e.id))})]})},m=()=>{var e,s;let t=(0,i.useRouter)(),{id:r}=t.query,[n,c]=(0,l.useState)(null),[m,u]=(0,l.useState)([]),[h,g]=(0,l.useState)([]),[p,b]=(0,l.useState)([]),[j,y]=(0,l.useState)([]),[N,v]=(0,l.useState)(!0),[f,w]=(0,l.useState)(!1),[_,k]=(0,l.useState)(!1),[D,C]=(0,l.useState)({category:"",priority:"",status:"",assigned_to:"",is_psea:!1,tags:[]});(0,l.useEffect)(()=>{r&&S()},[r]);let S=async()=>{try{v(!0);let[e,s,t,a,l]=await Promise.all([d.E.get("/tickets/".concat(r,"/")),d.E.get("/users/"),d.E.get("/categories/"),d.E.get("/priorities/"),d.E.get("/statuses/")]);c(e),u(s.results||s),g(t.results||t),b(a.results||a),y(l.results||l),e&&C({category:e.category||"",priority:e.priority||"",status:e.status||"",assigned_to:e.assigned_to||"",is_psea:e.is_psea||!1,tags:e.tags||[]})}catch(e){console.error("Erreur lors du chargement des donn\xe9es:",e)}finally{v(!1)}},E=async()=>{try{k(!0),await d.E.patch("/tickets/".concat(r,"/"),D),await S(),w(!1)}catch(e){console.error("Erreur lors de la sauvegarde:",e)}finally{k(!1)}},A=e=>new Date(e).toLocaleString("fr-FR");return N?(0,a.jsx)("div",{className:"flex justify-center items-center min-h-screen",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"})}):n?(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h2",{className:"text-2xl font-bold text-gray-900",children:["Ticket #",n.id]}),(0,a.jsx)("p",{className:"text-gray-600 mt-2",children:n.title})]}),(0,a.jsx)("div",{className:"flex space-x-3",children:f?(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("button",{onClick:E,disabled:_,className:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50",children:_?"Sauvegarde...":"Sauvegarder"}),(0,a.jsx)("button",{onClick:()=>{w(!1),n&&C({category:n.category||"",priority:n.priority||"",status:n.status||"",assigned_to:n.assigned_to||"",is_psea:n.is_psea||!1,tags:n.tags||[]})},className:"bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700",children:"Annuler"})]}):(0,a.jsx)("button",{onClick:()=>w(!0),className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",children:"Modifier"})})]})}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Informations du ticket"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Titre"}),(0,a.jsx)("p",{className:"mt-1 text-gray-900",children:n.title})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Contenu"}),(0,a.jsx)("div",{className:"mt-1 p-4 bg-gray-50 rounded border",children:(0,a.jsx)("p",{className:"text-gray-900 whitespace-pre-wrap",children:n.content})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Canal"}),(0,a.jsx)("p",{className:"mt-1 text-gray-900",children:n.channel_name})]}),n.is_anonymous?(0,a.jsx)("div",{className:"bg-yellow-50 border border-yellow-200 rounded p-3",children:(0,a.jsx)("p",{className:"text-yellow-800 font-medium",children:"⚠️ Ticket anonyme"})}):(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[n.submitter_name&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Nom du plaignant"}),(0,a.jsx)("p",{className:"mt-1 text-gray-900",children:n.submitter_name})]}),n.submitter_phone&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"T\xe9l\xe9phone"}),(0,a.jsx)("p",{className:"mt-1 text-gray-900",children:n.submitter_phone})]}),n.submitter_email&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Email"}),(0,a.jsx)("p",{className:"mt-1 text-gray-900",children:n.submitter_email})]}),n.submitter_location&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Localisation"}),(0,a.jsx)("p",{className:"mt-1 text-gray-900",children:n.submitter_location})]})]})]})]}),n.attachments&&n.attachments.length>0&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Pi\xe8ces jointes"}),(0,a.jsx)("div",{className:"space-y-2",children:n.attachments.map((e,s)=>(0,a.jsxs)("div",{className:"flex items-center space-x-2 p-2 bg-gray-50 rounded",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"\uD83D\uDCCE"}),(0,a.jsx)("span",{className:"text-gray-900",children:e.name||"Fichier ".concat(s+1)})]},s))})]}),n.tags&&n.tags.length>0&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Tags"}),(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:n.tags.map((e,s)=>(0,a.jsx)("span",{className:"bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm",children:e},s))})]})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Classification"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Cat\xe9gorie"}),f?(0,a.jsxs)("select",{value:D.category,onChange:e=>C({...D,category:e.target.value}),className:"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[(0,a.jsx)("option",{value:"",children:"S\xe9lectionner une cat\xe9gorie"}),h.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.name," ",e.is_sensitive&&"(Sensible)"]},e.id))]}):(0,a.jsx)("p",{className:"mt-1 text-gray-900",children:n.category_name})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Priorit\xe9"}),f?(0,a.jsxs)("select",{value:D.priority,onChange:e=>C({...D,priority:e.target.value}),className:"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[(0,a.jsx)("option",{value:"",children:"S\xe9lectionner une priorit\xe9"}),p.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.name," (Niveau ",e.level,")"]},e.id))]}):(0,a.jsxs)("div",{className:"mt-1 flex items-center space-x-2",children:[(0,a.jsx)("span",{className:"inline-block w-3 h-3 rounded-full",style:{backgroundColor:(e=>{let s=p.find(s=>s.name===e);return(null==s?void 0:s.color)||"#000000"})(n.priority_name)}}),(0,a.jsx)("span",{className:"text-gray-900",children:n.priority_name})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Statut"}),f?(0,a.jsxs)("select",{value:D.status,onChange:e=>C({...D,status:e.target.value}),className:"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[(0,a.jsx)("option",{value:"",children:"S\xe9lectionner un statut"}),j.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))]}):(0,a.jsxs)("div",{className:"mt-1 flex items-center space-x-2",children:[(0,a.jsx)("span",{className:"inline-block w-3 h-3 rounded-full",style:{backgroundColor:(e=>{let s=j.find(s=>s.name===e);return(null==s?void 0:s.color)||"#000000"})(n.status_name)}}),(0,a.jsx)("span",{className:"text-gray-900",children:n.status_name})]})]})]})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Assignation"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Assign\xe9 \xe0"}),f?(0,a.jsxs)("select",{value:D.assigned_to,onChange:e=>C({...D,assigned_to:e.target.value}),className:"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[(0,a.jsx)("option",{value:"",children:"Non assign\xe9"}),m.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.first_name," ",e.last_name," (",e.username,")"]},e.id))]}):(0,a.jsx)("p",{className:"mt-1 text-gray-900",children:n.assigned_to?(null===(e=m.find(e=>e.id===n.assigned_to))||void 0===e?void 0:e.first_name)+" "+(null===(s=m.find(e=>e.id===n.assigned_to))||void 0===s?void 0:s.last_name)||"Utilisateur inconnu":"Non assign\xe9"})]})]}),n.is_psea&&(0,a.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-red-800 mb-4",children:"⚠️ Protocole PSEA"}),(0,a.jsxs)("div",{className:"space-y-2 text-red-700",children:[(0,a.jsx)("p",{className:"font-medium",children:"Ticket sensible - Protection contre l'exploitation et les abus sexuels"}),(0,a.jsxs)("p",{children:["Escalad\xe9: ",n.psea_escalated?"Oui":"Non"]}),(0,a.jsx)("p",{className:"text-sm",children:"Acc\xe8s restreint aux personnes autoris\xe9es uniquement"})]})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"M\xe9tadonn\xe9es"}),(0,a.jsxs)("div",{className:"space-y-3 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium text-gray-700",children:"Cr\xe9\xe9 le:"}),(0,a.jsx)("span",{className:"ml-2 text-gray-900",children:A(n.created_at)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium text-gray-700",children:"Modifi\xe9 le:"}),(0,a.jsx)("span",{className:"ml-2 text-gray-900",children:A(n.updated_at)})]}),n.closed_at&&(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium text-gray-700",children:"Ferm\xe9 le:"}),(0,a.jsx)("span",{className:"ml-2 text-gray-900",children:A(n.closed_at)})]}),n.sla_deadline&&(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium text-gray-700",children:"\xc9ch\xe9ance SLA:"}),(0,a.jsx)("span",{className:"ml-2 text-gray-900",children:A(n.sla_deadline)})]})]})]})]})]}),(0,a.jsx)("div",{children:(0,a.jsx)(o,{ticketId:n.id})}),(0,a.jsx)("div",{children:(0,a.jsx)(x,{ticketId:n.id})})]}):(0,a.jsx)("div",{className:"max-w-4xl mx-auto p-6",children:(0,a.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[(0,a.jsx)("h1",{className:"text-xl font-semibold text-red-800 mb-2",children:"Ticket non trouv\xe9"}),(0,a.jsx)("p",{className:"text-red-600",children:"Le ticket demand\xe9 n'existe pas ou n'est pas accessible."}),(0,a.jsx)("button",{onClick:()=>t.push("/tickets"),className:"mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700",children:"Retour \xe0 la liste"})]})})},u=()=>{let e=(0,i.useRouter)();return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n(),{children:[(0,a.jsx)("title",{children:"D\xe9tail du ticket - CFRM"}),(0,a.jsx)("meta",{name:"description",content:"D\xe9tail et gestion du ticket de feedback"})]}),(0,a.jsx)(c.Z,{children:(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"D\xe9tail du ticket"}),(0,a.jsx)("button",{onClick:()=>e.push("/tickets"),className:"text-gray-500 hover:text-gray-700",children:(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,a.jsx)(m,{})]})})]})}},9008:function(e,s,t){e.exports=t(9201)}},function(e){e.O(0,[430,117,214,774,888,179],function(){return e(e.s=1642)}),_N_E=e.O()}]);